name: è‡ªåŠ¨æ‰“åŒ…Flutter APK

# è§¦å‘æ¡ä»¶ï¼šæ¨é€tagæˆ–æ‰‹åŠ¨è§¦å‘
on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€vå¼€å¤´çš„tagæ—¶è§¦å‘ï¼Œå¦‚ v1.0.0
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-apk:
    name: æ„å»ºAndroid APK
    runs-on: ubuntu-latest
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      # 2. è®¾ç½®Javaç¯å¢ƒ
      - name: è®¾ç½®Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      # 3. è®¾ç½®Flutterç¯å¢ƒ
      - name: è®¾ç½®Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
      
      # 4. è·å–ä¾èµ–
      - name: å®‰è£…ä¾èµ–
        run: flutter pub get
      
      # 5. æ‰“åŒ…APK
      - name: æ„å»ºAPK
        run: flutter build apk --release --split-per-abi
      
      # 6. è·å–ç‰ˆæœ¬å·
      - name: è·å–ç‰ˆæœ¬å·
        id: version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=dev-$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT
          fi
      
      # 7. é‡å‘½åAPKæ–‡ä»¶
      - name: é‡å‘½åAPK
        run: |
          mkdir -p release
          cp build/app/outputs/flutter-apk/app-arm64-v8a-release.apk release/game_code_app-${{ steps.version.outputs.VERSION }}-arm64.apk
          cp build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk release/game_code_app-${{ steps.version.outputs.VERSION }}-arm32.apk || true
          cp build/app/outputs/flutter-apk/app-x86_64-release.apk release/game_code_app-${{ steps.version.outputs.VERSION }}-x86.apk || true
      
      # 8. ä¸Šä¼ APKä¸ºArtifact
      - name: ä¸Šä¼ APK
        uses: actions/upload-artifact@v4
        with:
          name: apk-${{ steps.version.outputs.VERSION }}
          path: release/*.apk
      
      # 9. åˆ›å»ºGitHub Releaseï¼ˆä»…tagè§¦å‘æ—¶ï¼‰
      - name: åˆ›å»ºRelease
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: release/*.apk
          body: |
            ## æ¸¸æˆç å® ${{ steps.version.outputs.VERSION }}
            
            ### ğŸ“± ä¸‹è½½APK
            
            **æ¨èä¸‹è½½ï¼š** `game_code_app-${{ steps.version.outputs.VERSION }}-arm64.apk`
            - é€‚ç”¨äº99%çš„ç°ä»£Androidæ‰‹æœºï¼ˆ2015å¹´åï¼‰
            - æ–‡ä»¶å¤§å°çº¦10MB
            
            **å…¶ä»–ç‰ˆæœ¬ï¼š**
            - `arm32.apk` - é€‚ç”¨äºæ—§æ¬¾32ä½æ‰‹æœº
            - `x86.apk` - é€‚ç”¨äºx86æ¶æ„è®¾å¤‡ï¼ˆæå°‘ï¼‰
            
            ### ğŸ“¥ å®‰è£…æ–¹æ³•
            
            1. ç‚¹å‡»ä¸‹è½½APKæ–‡ä»¶
            2. åœ¨æ‰‹æœºä¸Šæ‰“å¼€ä¸‹è½½çš„æ–‡ä»¶
            3. å…è®¸"æœªçŸ¥æ¥æº"å®‰è£…
            4. å®‰è£…å®Œæˆåæ‰“å¼€åº”ç”¨
            
            ### âœ¨ æ›´æ–°å†…å®¹
            
            - è‡ªåŠ¨ä»GitHubè·å–æœ€æ–°å…‘æ¢ç 
            - å›½å†…CDNåŠ é€Ÿï¼Œæ— éœ€VPN
            - æ”¯æŒæœç´¢ã€ç­›é€‰ã€æ’åº
            - ä¸€é”®å¤åˆ¶å…‘æ¢ç 
            
            ---
            
            **å®Œæ•´æ›´æ–°æ—¥å¿—è¯·æŸ¥çœ‹æäº¤è®°å½•**
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
